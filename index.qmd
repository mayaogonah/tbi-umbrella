---
title: "Health Outcomes Following TBI"
subtitle: "An umbrella review of a wide range of health outcomes following traumatic brain injury (TBI). This document is an accompanying file of the paper: Ogonah et al. <strong>An umbrella review of health outcomes following traumatic brain injury.</strong> <i>Nature Mental Health.</i> Jan 2025. <a href='https://www.nature.com/articles/s44220-024-00356-5'>10.1038/s44220-024-00356-5. </a>"

format:
  lumo-html: 
    #logo:  #optional: add your logo to the doc header
    primary-color: "#b5cef7"
    github-repo: "https://github.com/mayaogonah" 
    self-contained: true
    is-particlejs-enabled: true  # optional: display interactive particles in the doc header
    #bg-image:  # optional: add a background image

author: Maya Ogonah, University of Oxford
date: today
    
---

## Libraries and data

All packages are loaded before analysis.
```{r, message=FALSE, results='hide'}
if (!require("pacman")) install.packages("pacman")

library(pacman)
pacman::p_load(
  meta,
  extrafont,
  effectsize,
  metafor,
  DescTools,
  openxlsx,
  tidyverse,
  metafor,
  cowplot,
  robvis,
  ggplot2
  )
```

Here I import an Excel file which includes extracted data from each review, including the effect sizes for each health outcome.
```{r}
data <- read.xlsx("forest_plot.xlsx")
data_rob1 <- read.xlsx("amstar2_rob.xlsx")
```

## Prisma flow diagram 

::: {.cell .page-columns .page-full .column-screen .grey-section}
The Prisma flow diagram was created using a [Shiny tool](https://estech.shinyapps.io/prisma_flowdiagram/).
:::


## Quality assessment 

::: {.cell .page-columns .page-full .column-screen .grey-section}
The [Robvis tool](https://mcguinlu.shinyapps.io/robvis/) was used to create the AMSTAR 2 across domains diagram. 
:::

## Forest plot

Risk estimates of health outcomes following TBI were visually displayed on a forest plot
using the ‘metafor’ package.
```{r, fig.width=12, fig.height=8}
shapes = c(15, 17, 18)
shapes <- shapes[as.numeric(data$Group)]

  forest(x = data$Summary.Statistic, ci.lb = data$Lower.CI, ci.ub = data$Upper.CI, 
         slab = data$Health.Outcome,
         psize = rep(1, length(data$Summary.Statistic)),
         xlab = "Risk Ratio (RR)", refline = 1.0,
         ylim = c(-0.5, 31), xlim = c(-6, 10),
         ilab = c(data$Sample.size), ilab.xpos = -1,
         at = c(0.5, 1.0, 2, 4, 8),
         rows = c(1:2, 5, 8, 11:16, 19:27),
         cex = 1.0, pch = shapes, header = "Health Outcome")
  
  
  op <- par(cex=1.0, font=2)
  text(-6, c(3, 6, 9, 17, 28), pos = 4,
       c("Severe TBI", "Moderate to Severe TBI", "Moderate TBI", "Mild TBI", "TBI of any severity"))
  
  op <- par(cex=1.0, font=2)
  text(7.9, 30.1, "RR")
  
  op <- par(cex=1.0, font=2)
  text(-1, 30.1, "Sample Size")
  
```

## Converting effect sizes

Where presented, all effect sizes and confidence intervals (except hazard ratios, which cannot be transformed) were converted to risk ratios for better communication of research findings and to enable comparison across outcomes.

### Hedge's g to RR

Hedge's g was considered approximately equivalent to Cohen's d. The following code was used to convert cohen's d to OR, which was inturn converted into a RR using the code below.

```{r}
OR <- d_to_oddsratio(4.22, log = FALSE)

var_d <- 0.79

variance_OR <- exp(var_d * (pi^2 / 3))

var_ll <- OR - variance_OR
var_ul <- OR + variance_OR
```

### OR to RR

I converted ORs to RR using the *ORTORelRisk* package in DescTools.

```{r, results='hide'}
## Include ..c(OR, UL, CL, p0)
## p0 is the baseline risk 

ORToRelRisk(c(6.70, 2.02, 16.82), 0.011319)
```

### PR to RR

Prevalence ratios were converted to RR using the following code.

```{r}
prevalence_ratio <- 4.51  # Replace with your prevalence ratio
prevalence_reference <- 0.217  # Replace with the prevalence in the reference group

risk_ratio <- prevalence_ratio / (1 - prevalence_reference + (prevalence_reference * prevalence_ratio))

  ## calculate lower limit ###
  ll_prevalence_ratio <- 2.12  # Replace with your prevalence ratio
  ll_prevalence_reference <- 0.217  # Replace with the prevalence in the reference group
  
  ll_risk_ratio <- prevalence_ratio / (1 - ll_prevalence_reference + (ll_prevalence_reference * ll_prevalence_ratio))
  
  ## calculate upper limit ###
  ul_prevalence_ratio <- 9.58  # Replace with your prevalence ratio
  ul_prevalence_reference <- 0.217  # Replace with the prevalence in the reference group
  
  ul_risk_ratio <- prevalence_ratio / (1 - ul_prevalence_reference + (ul_prevalence_reference * ul_prevalence_ratio))

```

## Population attributable fractions

Population attributable fractions (PAFs) were calculated for each health outcome using Levin's formula, as most included review reported unadjusted effect sizes and presented only summary data. The PAF assumes casualty and can be interpreted as the **maximum possible impact** of preventing all TBIs for an outcome. 

:::callout-note
We calculated the PAF using a conservative [12% prevalence estimate](https://karger.com/ned/article/40/3/154/210971/Prevalence-of-Traumatic-Brain-Injury-in-the) of TBI.
:::

```{r, results='hide'}
p <- 0.12 # prevalence estimate of TBI 
z <- 1.96 # z score for a 95% CI
RRu <- 4.16 # risk ratio for the health outcome

n <- (2508948+7352205) # study sample size

# calculate PAF using Levins Formula
PAF <- p * (RRu - 1) / (1 + p * (RRu - 1))

# convert PAF to percentage
PAF_percentage <- PAF * 100

# calculate standard error (SE)
SE <- sqrt(p * (1 - p) / (n * (RRu - 1)^2))

# calculate margin of error
MOE <- z * SE

# Cclculate 95% CI
lower_CI <- (PAF - MOE) * 100
upper_CI <- (PAF + MOE) * 100

# print the results
cat("Population Attributable Fraction (PAF):", PAF_percentage, "%\n")
cat("95% Confidence Interval:", lower_CI, "% to", upper_CI, "%\n")
```

